// lab04_2_self_patching.c
#define _GNU_SOURCE
#include <stdio.h>
#include <stdint.h>
#include <sys/mman.h>
#include <unistd.h>

__attribute__((noinline))
void secret() {
    puts("üî• REAL PAYLOAD EXECUTED üî•");
}

__attribute__((noinline))
void fake() {
    puts("‚ùå FAKE PATH ‚ùå");
}

__attribute__((noinline))
void entry() {
    volatile int x = 0;

    if (x == 1) {
        secret();   // unreachable statically
    } else {
        fake();     // always taken statically
    }
}

int main() {
    size_t page_size = sysconf(_SC_PAGESIZE);
    uintptr_t page = (uintptr_t)entry & ~(page_size - 1);

    // Make code writable
    mprotect((void*)page, page_size,
             PROT_READ | PROT_WRITE | PROT_EXEC);

    unsigned char *p = (unsigned char*)entry;

    /*
     * We flip:
     *   jne ‚Üí je   OR
     *   jne ‚Üí nop nop
     *
     * This exact offset must be found by RE
     */
    for (int i = 0; i < 64; i++) {
        if (p[i] == 0x75) {   // JNE
            p[i] = 0x74;     // JE
            break;
        }
    }

    entry();
    return 0;
}
