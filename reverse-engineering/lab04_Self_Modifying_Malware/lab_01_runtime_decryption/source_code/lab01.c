#define _GNU_SOURCE
#include <stdint.h>
#include <unistd.h>
#include <sys/mman.h>
#include <string.h>

/*
    Encrypted x86_64 machine code
    Payload (after decryption):
        write(1, "LAB04-1 OK\n", 10)
        exit(0)
*/

static uint8_t enc_payload[] = {
    0x3a,0xa9,0x55,0x12,0x1f,0x93,0x3a,0xa9,
    0x55,0x12,0x1f,0x9b,0x3a,0xa9,0x55,0x12,
    0x1f,0x8b,0x7a,0xed,0x10,0x52,0x1f,0x8b,
    0x7a,0xed,0x10,0x5a,0x4f,0xe8,0x55,0x12,
    0x5b,0x8b,0x4f,0xe8,0x55,0x12,0x5b,0x93,
    0x4f,0xe8,0x55,0x12,0x5b,0x9b,0x1e,0xaf
};

__attribute__((noinline))
static void decrypt(uint8_t *buf, size_t len) {
    volatile uint8_t key = 0xAA;
    for (size_t i = 0; i < len; i++) {
        buf[i] ^= key;
        key = (key + 0x3D) ^ i;
    }
}

int main() {
    size_t size = sizeof(enc_payload);

    uintptr_t page = (uintptr_t)enc_payload & ~(uintptr_t)(0x1000 - 1);
    mprotect((void*)page, 0x1000, PROT_READ | PROT_WRITE | PROT_EXEC);

    decrypt(enc_payload, size);

    ((void(*)())enc_payload)();

    return 0;
}
